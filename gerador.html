<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Relatórios de Auditoria - Zara Home</title>
    <script src="auth-guard.js" defer></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #374151; }
        input, textarea, select { border-radius: 0.5rem; border: 1px solid #d1d5db; padding: 0.5rem 0.75rem; width: 100%; font-size: 0.875rem; background-color: #ffffff; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
        input:focus, textarea:focus, select:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); }
        .btn { padding: 0.75rem 1.25rem; border-radius: 0.5rem; font-weight: 600; transition: background-color 200ms cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer; }
        .btn-primary { background-color: #2563eb; color: #ffffff; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .btn-primary:hover { background-color: #1d4ed8; }
        .btn-primary:disabled { background-color: #9ca3af; cursor: not-allowed; }
        .btn-secondary { background-color: #6b7280; color: #ffffff; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .btn-secondary:hover { background-color: #4b5563; }
        .station-section { background-color: #fefefe; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); }
    </style>
</head>
<body class="bg-stone-50 text-gray-800">

<div id="conteudo-protegido" style="display: none;">
    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-4xl">
        <div class="mb-6 flex flex-col sm:flex-row sm:justify-between sm:items-center">
            <a href="reportszh.html" class="inline-flex items-center text-blue-600 hover:text-blue-800 font-medium mb-4 sm:mb-0">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                Voltar para a Lista de Relatórios
            </a>
            <div class="flex items-center space-x-2 justify-end">
                <span class="text-gray-700 text-sm hidden sm:block">Olá, Ismael</span>
                <button class="bg-white text-blue-600 border border-blue-600 rounded-md px-3 py-1 text-sm hover:bg-blue-500 hover:text-white transition-colors duration-200">Meu Perfil</button>
                <button class="bg-red-600 text-white rounded-md px-3 py-1 text-sm hover:bg-red-700 transition-colors duration-200">Sair</button>
            </div>
        </div>

        <header class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">Gerador de Relatórios de Auditoria</h1>
            <p class="text-lg text-gray-600">Preencha os detalhes para gerar e publicar um novo relatório.</p>
        </header>
        <form id="report-generator-form" class="bg-white p-8 rounded-lg shadow-xl border">
            <div id="message-container" class="mb-4 text-center font-semibold"></div>
            <section class="mb-8 pb-8 border-b border-gray-200">
                <h2 class="text-xl font-bold text-gray-900 mb-4">Informações Gerais do Relatório</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="report-date" class="block text-sm font-medium text-gray-700 mb-1">Data do Relatório:</label>
                        <input type="date" id="report-date" name="reportDate" class="form-input" required>
                    </div>
                    <div>
                        <label for="report-sector" class="block text-sm font-medium text-gray-700 mb-1">Setor:</label>
                        <input type="text" id="report-sector" name="reportSector" class="form-input" value="Zara Home" required>
                    </div>
                </div>
            </section>
            <section id="stations-container" class="mb-8">
                   <h2 class="text-xl font-bold text-gray-900 mb-4">Detalhes das Estações de Trabalho</h2>
                <div id="station-fields-wrapper"></div>
            </section>
            <div class="flex flex-col sm:flex-row justify-end gap-4">
                <button type="button" id="download-offline-btn" class="btn btn-secondary flex items-center justify-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    Baixar HTML Offline
                </button>
                <button type="submit" id="publish-btn" class="btn btn-primary flex items-center justify-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M7 16a4 4 0 01-4 4H4M7 16l-4 4m4-4l4-4m-4 4v-7m0 0l4-4m-4 4H3m4 0h7m0 0l4 4m-4-4l-4 4m4-4V3m0 0l4 4m-4-4l-4 4"></path></svg>
                    Publicar Relatório no Site
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    const initializeApp = () => {
        const GITHUB_USER = "IsmaelVitale";
        const GITHUB_REPO = "ZaraHome";
        
        const form = document.getElementById('report-generator-form');
        const stationsContainer = document.getElementById('station-fields-wrapper');
        const messageContainer = document.getElementById('message-container');
        const publishBtn = document.getElementById('publish-btn');
        const downloadOfflineBtn = document.getElementById('download-offline-btn');
        const statusMapping = {
            printer: { 'Okay com ping': 'ok', 'Problema de Rede': 'attention', 'Offline': 'attention' },
            scanner: { 'Okay (sem fio)': 'ok', 'Ausente': 'critical', 'Apenas a base': 'attention', 'Fora do Padrão (com fio)': 'attention', 'Defeituoso': 'critical' },
            decoupler: { 'Luz verde (Okay)': 'ok', 'Luz vermelha (Erro)': 'attention', 'Luz apagada (Inoperante)': 'attention' }
        };
        const fixedStationData = [
            { id: 'TGT0002', serial: 'CZC4277318' }, { id: 'TGT0003', serial: 'CZC4267SPW' },
            { id: 'TGT0004', serial: 'CZC4197BVT' }, { id: 'TGT0005', serial: 'CZC4197BVL' },
            { id: 'TGT0006', serial: 'CZC4197BVM' }, { id: 'TGT0007', serial: 'CZC4197BVR' },
            { id: 'TGT0008', serial: 'CZC4197BVK' }, { id: 'TGT0009', serial: 'CZC4197BVQ' },
            { id: 'TGT0010', serial: 'CZC4197BVN' }, { id: 'TGT0011', serial: 'CZC4197BVP' },
            { id: 'TGT0012', serial: 'CZC4257GBN' }, { id: 'TGT0013', serial: 'CZC4257GBP' }
        ];

        function renderStationFields() {
            stationsContainer.innerHTML = '';
            fixedStationData.forEach(stationData => {
                const stationDiv = document.createElement('div');
                stationDiv.className = 'station-section';
                let optionsHtml = (type) => Object.keys(statusMapping[type]).map(option => `<option value="${option}">${option}</option>`).join('');
                stationDiv.innerHTML = `<div class="flex justify-between items-center mb-4"><h3 class="text-lg font-semibold text-gray-800">Estação ${stationData.id}</h3></div><div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4"><div><label class="block text-sm font-medium text-gray-700 mb-1">ID da Estação:</label><input type="text" name="stationId" class="form-input bg-gray-100 cursor-not-allowed" value="${stationData.id}" readonly></div><div><label class="block text-sm font-medium text-gray-700 mb-1">Nº de Série (TGT):</label><input type="text" name="serial" class="form-input" value="${stationData.serial}"></div></div><div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4"><div><label class="block text-sm font-medium text-gray-700 mb-1">Status Impressora:</label><select name="printerStatus" class="form-input" required><option value="" disabled selected>Selecione</option>${optionsHtml('printer')}</select></div><div><label class="block text-sm font-medium text-gray-700 mb-1">Status Scanner:</label><select name="scannerStatus" class="form-input" required><option value="" disabled selected>Selecione</option>${optionsHtml('scanner')}</select></div><div><label class="block text-sm font-medium text-gray-700 mb-1">Status Desacoplador:</label><select name="decouplerStatus" class="form-input" required><option value="" disabled selected>Selecione</option>${optionsHtml('decoupler')}</select></div></div><div><label class="block text-sm font-medium text-gray-700 mb-1">Observações:</label><textarea name="observations" rows="2" class="form-input" placeholder="Nenhuma observação..."></textarea></div>`;
                stationsContainer.appendChild(stationDiv);
            });
        }

        function getReportData() {
            const reportDateInput = document.getElementById('report-date').value;
            if (!reportDateInput) {
                messageContainer.textContent = 'ERRO: Por favor, selecione a data do relatório.';
                return null;
            }
            messageContainer.textContent = '';
            const reportSectorInput = document.getElementById('report-sector').value;
            const [year, month, day] = reportDateInput.split('-');
            const formattedDate = `${day}/${month}/${year}`;
            const collectedStationData = Array.from(document.querySelectorAll('.station-section')).map(section => {
                const printerText = section.querySelector('select[name="printerStatus"]').value || 'Não preenchido';
                const scannerText = section.querySelector('select[name="scannerStatus"]').value || 'Não preenchido';
                const decouplerText = section.querySelector('select[name="decouplerStatus"]').value || 'Não preenchido';
                const printerStatusKey = statusMapping.printer[printerText] || 'neutral';
                const scannerStatusKey = statusMapping.scanner[scannerText] || 'neutral';
                const decouplerStatusKey = statusMapping.decoupler[decouplerText] || 'neutral';
                let overallStatus = 'ok';
                if (printerStatusKey === 'critical' || scannerStatusKey === 'critical' || decouplerStatusKey === 'critical') overallStatus = 'critical';
                else if (printerStatusKey === 'attention' || scannerStatusKey === 'attention' || decouplerStatusKey === 'attention') overallStatus = 'attention';
                return { id: section.querySelector('input[name="stationId"]').value, serial: section.querySelector('input[name="serial"]').value, printer: { status: printerStatusKey, text: printerText }, scanner: { status: scannerStatusKey, text: scannerText }, decoupler: { status: decouplerStatusKey, text: decouplerText }, obs: section.querySelector('textarea[name="observations"]').value, overall: overallStatus };
            });
            const totalStations = collectedStationData.length;
            const stationsWithOccurrences = collectedStationData.filter(s => s.overall !== 'ok').length;
            const decouplerErrorCount = collectedStationData.filter(s => s.decoupler.status !== 'ok').length;
            const scannerAbsentCount = collectedStationData.filter(s => s.scanner.text.includes('Ausente')).length;
            const decouplerFailureRate = totalStations > 0 ? ((decouplerErrorCount / totalStations) * 100).toFixed(0) : 0;
            return {
                reportInfo: { date: formattedDate, sector: reportSectorInput },
                kpis: { totalStations, stationsWithOccurrences, decouplerFailureRate, scannerAbsentCount },
                stationData: collectedStationData
            };
        }
        
        function dateToFileName(day, month) {
            const dias = ["", "um", "dois", "tres", "quatro", "cinco", "seis", "sete", "oito", "nove", "dez", "onze", "doze", "treze", "catorze", "quinze", "dezesseis", "dezessete", "dezoito", "dezenove", "vinte", "vinteum", "vintedois", "vintetres", "vintequatro", "vintecinco", "vinteseis", "vintesete", "vinteoito", "vintenove", "trinta", "trintaeum"];
            const meses = ["janeiro", "fevereiro", "marco", "abril", "maio", "junho", "julho", "agosto", "setembro", "outubro", "novembro", "dezembro"];
            return `${dias[day]}de${meses[month - 1]}`;
        }

        function downloadFile(content, fileName, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        // Função para gerar o HTML offline completo do painel de auditoria
        function generateOfflineHtml(reportData) {
            // Este é o conteúdo completo do seu 'relatorio.html' com os dados injetados.
            // Copiei o 'relatorio.html' que você forneceu anteriormente, com as correções de gráfico.
            // e os dados são passados como um objeto JS diretamente.
            return `
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Auditoria - ${reportData.reportInfo.sector}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .chart-container { position: relative; width: 100%; max-width: 320px; margin: auto; height: 320px; }
        .status-badge { display: inline-flex; align-items: center; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 500; }
        .status-ok { background-color: #dcfce7; color: #166534; }
        .status-attention { background-color: #fef9c3; color: #854d0e; }
        .status-critical { background-color: #fee2e2; color: #991b1b; }
        .status-neutral { background-color: #e5e7eb; color: #374151; }
        /* Os filtros da tabela não são dinâmicos no HTML offline, então não precisam de .filter-btn.active */
    </style>
</head>
<body class="bg-stone-50 text-gray-800">
    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <div class="mb-6">
            <a href="#" onclick="window.close()" class="inline-flex items-center text-blue-600 hover:text-blue-800 font-medium transition-colors duration-200">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                Fechar Relatório
            </a>
        </div>
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">Painel de Auditoria de Estações de Trabalho</h1>
            <p class="text-lg text-gray-600">Setor: ${reportData.reportInfo.sector} | Data da Verificação: ${reportData.reportInfo.date}</p>
        </header>
        <section class="mb-8 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
            <div class="bg-white p-6 rounded-lg shadow-sm border"><h2 class="text-sm font-medium text-gray-500">Total de Estações</h2><p class="text-3xl font-semibold text-gray-900">${reportData.kpis.totalStations}</p></div>
            <div class="bg-white p-6 rounded-lg shadow-sm border"><h2 class="text-sm font-medium text-gray-500">Estações com Ocorrências</h2><p class="text-3xl font-semibold text-red-600">${reportData.kpis.stationsWithOccurrences}</p></div>
            <div class="bg-white p-6 rounded-lg shadow-sm border"><h2 class="text-sm font-medium text-gray-500">Taxa de Falha (Desacoplador)</h2><p class="text-3xl font-semibold text-red-600">${reportData.kpis.decouplerFailureRate}%</p></div>
            <div class="bg-white p-6 rounded-lg shadow-sm border"><h2 class="text-sm font-medium text-gray-500">Scanners Ausentes</h2><p class="text-3xl font-semibold text-yellow-600">${reportData.kpis.scannerAbsentCount}</p></div>
        </section>
        <section class="mb-8 bg-white p-6 rounded-lg shadow-sm border">
            <h2 class="text-xl font-bold text-gray-900 mb-6">Resumo Visual dos Equipamentos</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div><h3 class="text-lg font-semibold text-center text-gray-700 mb-2">Status dos Scanners</h3><div class="chart-container"><canvas id="scannerChart"></canvas></div></div>
                <div><h3 class="text-lg font-semibold text-center text-gray-700 mb-2">Status dos Desacopladores</h3><div class="chart-container"><canvas id="decouplerChart"></canvas></div></div>
            </div>
        </section>
        <section>
            <div class="bg-white p-6 rounded-lg shadow-sm border">
                <h2 class="text-xl font-bold text-gray-900 mb-4">Detalhes por Estação de Trabalho</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estação</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nº de Série</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Impressora</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Scanner</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Desacoplador</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Observação</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status Geral</th>
                            </tr>
                        </thead>
                        <tbody id="station-table-body" class="bg-white divide-y">
                            ${reportData.stationData.map(station => {
                                const statusMapOffline = {
                                    ok: { class: 'status-ok', icon: '<svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>' },
                                    attention: { class: 'status-attention', icon: '<svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>' },
                                    critical: { class: 'status-critical', icon: '<svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"></path></svg>' },
                                    neutral: { class: 'status-neutral', icon: '' }
                                };
                                const overallText = station.overall === 'ok' ? 'Conforme' : station.overall.charAt(0).toUpperCase() + station.overall.slice(1);
                                return `
                                    <tr class="bg-white hover:bg-gray-50">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${station.id}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${station.serial}</td>
                                        <td class="px-6 py-4 whitespace-nowrap"><span class="status-badge ${statusMapOffline[station.printer.status].class}">${statusMapOffline[station.printer.status].icon}${station.printer.text}</span></td>
                                        <td class="px-6 py-4 whitespace-nowrap"><span class="status-badge ${statusMapOffline[station.scanner.status].class}">${statusMapOffline[station.scanner.status].icon}${station.scanner.text}</span></td>
                                        <td class="px-6 py-4 whitespace-nowrap"><span class="status-badge ${statusMapOffline[station.decoupler.status].class}">${statusMapOffline[station.decoupler.status].icon}${station.decoupler.text}</span></td>
                                        <td class="px-6 py-4 text-sm text-gray-600 break-words max-w-xs">${station.obs}</td>
                                        <td class="px-6 py-4 whitespace-nowrap"><span class="status-badge ${statusMapOffline[station.overall].class}">${overallText}</span></td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
    </div>
    <script>
        // O JS para os gráficos do HTML offline
        document.addEventListener('DOMContentLoaded', () => {
            // Os dados do relatório são diretamente injetados aqui
            const reportDataOffline = ${JSON.stringify(reportData)}; 
            
            const scannerCounts = reportDataOffline.stationData.reduce((acc, s) => {
                (s.scanner.text.includes('Okay')) ? acc.ok++ :
                (s.scanner.text.includes('Ausente')) ? acc.absent++ :
                (s.scanner.text.includes('Padrão')) ? acc.nonStandard++ :
                (s.scanner.text.includes('base')) && acc.incomplete++;
                return acc;
            }, { ok: 0, absent: 0, nonStandard: 0, incomplete: 0 });

            const decouplerCounts = reportDataOffline.stationData.reduce((acc, s) => {
                (s.decoupler.text.includes('verde')) ? acc.ok++ :
                (s.decoupler.text.includes('vermelha')) ? acc.error++ :
                (s.decoupler.text.includes('apagada')) && acc.off++;
                return acc;
            }, { ok: 0, error: 0, off: 0 });

            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            boxWidth: 12,
                            font: { size: 14 }
                        }
                    },
                    tooltip: {
                        bodyFont: { size: 14 },
                        titleFont: { size: 16 }
                    }
                },
                cutout: '60%'
            };

            // Certifique-se de que o canvas existe antes de tentar criar o gráfico
            const scannerChartCanvas = document.getElementById('scannerChart');
            if (scannerChartCanvas) {
                new Chart(scannerChartCanvas, {
                    type: 'doughnut',
                    data: {
                        labels: ['Conforme', 'Ausente', 'Fora do Padrão', 'Incompleto'],
                        datasets: [{
                            data: [scannerCounts.ok, scannerCounts.absent, scannerCounts.nonStandard, scannerCounts.incomplete],
                            backgroundColor: ['#22c55e', '#ef4444', '#f97316', '#eab308'],
                            borderWidth: 2
                        }]
                    },
                    options: chartOptions
                });
            }

            const decouplerChartCanvas = document.getElementById('decouplerChart');
            if (decouplerChartCanvas) {
                new Chart(decouplerChartCanvas, {
                    type: 'doughnut',
                    data: {
                        labels: ['Conforme', 'Com Erro', 'Inoperante'],
                        datasets: [{
                            data: [decouplerCounts.ok, decouplerCounts.error, decouplerCounts.off],
                            backgroundColor: ['#22c55e', '#ef4444', '#f59e0b'],
                            borderWidth: 2
                        }]
                    },
                    options: chartOptions
                });
            }
        });
    </script>
</body>
</html>
            `;
        }


        renderStationFields();

        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            const reportData = getReportData();
            if (!reportData) return;

            publishBtn.disabled = true;
            publishBtn.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Publicando...`;
            messageContainer.textContent = 'A contactar o servidor seguro...';
            messageContainer.className = 'mb-4 text-center font-semibold text-blue-600';

            const [year, month, day] = reportData.reportInfo.date.split('/').map(Number); // Converte para número
            const reportFileName = `${dateToFileName(day, month)}.json`; // Ajusta para usar dia e mês

            const payload = {
                GITHUB_USER: GITHUB_USER,
                GITHUB_REPO: GITHUB_REPO,
                event_type: 'add-new-report',
                client_payload: {
                    report_date: reportData.reportInfo.date,
                    report_filename: reportFileName,
                    report_data: JSON.stringify(reportData, null, 2)
                }
            };
            
            try {
                const response = await fetch('/api/publish-report', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (response.ok) {
                    messageContainer.textContent = 'Publicação iniciada com sucesso! Aguarde 1-2 minutos para o site atualizar.';
                    messageContainer.className = 'mb-4 text-center font-semibold text-green-600';
                } else {
                    throw new Error(result.message || 'Ocorreu um erro desconhecido no servidor.');
                }

            } catch (error) {
                console.error('Erro ao comunicar com o despachante:', error);
                messageContainer.textContent = `Falha na publicação: ${error.message}`;
                messageContainer.className = 'mb-4 text-center font-semibold text-red-600';
            } finally {
                publishBtn.disabled = false;
                publishBtn.innerHTML = '<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M7 16a4 4 0 01-4 4H4M7 16l-4 4m4-4l4-4m-4 4v-7m0 0l4-4m-4 4H3m4 0h7m0 0l4 4m-4-4l-4 4m4-4V3m0 0l4 4m-4-4l-4 4"></path></svg>Publicar Relatório no Site';
            }
        });

        downloadOfflineBtn.addEventListener('click', function() {
            const reportData = getReportData();
            if (!reportData) return;
            
            // Para download offline, use a data completa para o nome do arquivo, se preferir
            const [year, month, day] = reportData.reportInfo.date.split('/').map(Number); // Mapeia para números
            const reportFileNameSuffix = `${dateToFileName(day, month)}`;
            const offlineHtml = generateOfflineHtml(reportData); 
            downloadFile(offlineHtml, `relatorio_auditoria_zara_home_${reportFileNameSuffix}.html`, 'text/html');
        });
    };
    
    document.addEventListener('authReady', initializeApp, { once: true });
</script>
</body>
</html>
